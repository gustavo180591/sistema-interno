{% extends 'base.html.twig' %}

{% block title %}Tickets - Sistema Interno{% endblock %}

{% block body %}
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-ticket-alt me-2"></i>
                        {% if app.request.query.get('status') == 'completed' %}
                            Tickets Completados
                        {% else %}
                            Tickets
                        {% endif %}
                    </h1>
                    {% if app.request.query.get('status') == 'completed' %}
                        <a href="{{ path('ticket_index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver al inicio
                        </a>
                    {% elseif is_granted('ROLE_ADMIN') or is_granted('ROLE_AUDITOR') %}
                        <a href="{{ path('ticket_new') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Nuevo Ticket
                        </a>
                    {% endif %}
                </div>

                {% if tickets is empty %}
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-ticket-alt fa-4x text-muted mb-3"></i>
                            <h3 class="h5">
                                {% if app.request.query.get('status') == 'completed' %}
                                    No hay tickets completados
                                {% else %}
                                    No hay tickets disponibles
                                {% endif %}
                            </h3>
                            <p class="text-muted">
                                {% if app.request.query.get('status') == 'completed' %}
                                    Todavía no se han completado tickets
                                {% elseif is_granted('ROLE_AUDITOR') %}
                                    Crea tu primer ticket para comenzar
                                {% else %}
                                    No tienes tickets asignados actualmente
                                    {% if not is_granted('ROLE_AUDITOR') %}
                                        <br><small class="text-muted">Solo los auditores pueden crear nuevos tickets</small>
                                    {% endif %}
                                {% endif %}
                            </p>
                            {% if is_granted('ROLE_AUDITOR') and app.request.query.get('status') != 'completed' %}
                                <a href="{{ path('ticket_new') }}" class="btn btn-primary mt-3">
                                    <i class="fas fa-plus me-2"></i>Crear primer ticket
                                </a>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="sortable {{ sort == 'id' ? 'active-sort' : '' }}" 
                                                data-sort="id" 
                                                style="cursor: pointer;"
                                                data-bs-toggle="tooltip" 
                                                title="Haz clic para ordenar por N.º Ticket">
                                                N.º Ticket
                                            </th>
                                            <th class="sortable {{ sort == 'title' ? 'active-sort' : '' }}" 
                                                data-sort="title" 
                                                style="cursor: pointer;"
                                                data-bs-toggle="tooltip" 
                                                title="Haz clic para ordenar por título">
                                                Detalle
                                            </th>
                                            <th class="sortable {{ sort == 'createdBy' ? 'active-sort' : '' }}" 
                                                data-sort="createdBy" 
                                                style="cursor: pointer;"
                                                data-bs-toggle="tooltip" 
                                                title="Haz clic para ordenar por auditor">
                                                Auditor
                                            </th>
                                            <th class="sortable {{ sort == 'assignedTo' ? 'active-sort' : '' }}" 
                                                data-sort="assignedTo" 
                                                style="cursor: pointer;"
                                                data-bs-toggle="tooltip" 
                                                title="Haz clic para ordenar por asignado">
                                                Asignado
                                            </th>
                                            <th class="sortable {{ sort == 'createdAt' ? 'active-sort' : '' }}" 
                                                data-sort="createdAt" 
                                                style="cursor: pointer;"
                                                data-bs-toggle="tooltip" 
                                                title="Haz clic para ordenar por fecha">
                                                Fecha y Hora
                                            </th>
                                            <th class="sortable {{ sort == 'status' ? 'active-sort' : '' }}" 
                                                data-sort="status" 
                                                style="cursor: pointer;"
                                                data-bs-toggle="tooltip" 
                                                title="Haz clic para ordenar por estado">
                                                Estado
                                            </th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ticket in tickets %}
                                            <tr>
                                                <td>{{ ticket.idSistemaInterno ?? 'N/A' }}</td>
                                                <td>
                                                    <a href="{{ path('ticket_show', {'id': ticket.id}) }}"
                                                       class="text-decoration-none" title="{{ ticket.title }}">
                                                        {{ ticket.title|length > 40 ? ticket.title|slice(0, 40) ~ '...' : ticket.title }}
                                                    </a>
                                                </td>
                                                <td>
                                                    {% if ticket.createdBy %}
                                                        {{ ticket.createdBy.nombre }} {{ ticket.createdBy.apellido }}
                                                    {% else %}
                                                        Sistema
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if ticket.ticketAssignments|length > 0 %}
                                                        {% for assignment in ticket.ticketAssignments %}
                                                            {{ assignment.user.nombre }} {{ assignment.user.apellido }}{% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="text-muted">Sin asignar</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div>{{ ticket.createdAt|date('d/m/Y') }}</div>
                                                    <small class="text-muted">{{ ticket.createdAt|date('H:i') }}</small>
                                                </td>
                                                <td>
                                                    {% set statusConfig = {
                                                        'pending': {
                                                            'class': 'bg-info bg-opacity-10 text-info border border-info',
                                                            'icon': 'fa-clock',
                                                            'text': 'Pendiente',
                                                            'description': 'El ticket está esperando ser atendido'
                                                        },
                                                        'in_progress': {
                                                            'class': 'bg-warning bg-opacity-10 text-warning border border-warning',
                                                            'icon': 'fa-spinner fa-spin',
                                                            'text': 'En progreso',
                                                            'description': 'El ticket está siendo atendido actualmente'
                                                        },
                                                        'completed': {
                                                            'class': 'bg-success bg-opacity-10 text-success border border-success',
                                                            'icon': 'fa-check-circle',
                                                            'text': 'Terminado',
                                                            'description': 'El ticket ha sido completado exitosamente'
                                                        },
                                                        'rejected': {
                                                            'class': 'bg-danger bg-opacity-10 text-danger border border-danger',
                                                            'icon': 'fa-times-circle',
                                                            'text': 'Rechazado',
                                                            'description': 'El ticket ha sido rechazado'
                                                        },
                                                        'delayed': {
                                                            'class': 'bg-warning bg-opacity-20 text-warning border border-warning',
                                                            'icon': 'fa-clock',
                                                            'text': 'Demorado',
                                                            'description': 'El ticket ha sido retrasado'
                                                        }
                                                    }[ticket.status] ?? {
                                                        'class': 'bg-secondary bg-opacity-10 text-secondary border border-secondary',
                                                        'icon': 'fa-question-circle',
                                                        'text': 'Desconocido',
                                                        'description': 'Estado desconocido'
                                                    } %}

                                                    <span class="badge {{ statusConfig.class }} d-inline-flex align-items-center"
                                                          data-bs-toggle="tooltip" 
                                                          data-bs-placement="top"
                                                          title="{{ statusConfig.description }}">
                                                        <i class="fas {{ statusConfig.icon }} me-1"></i>
                                                        {{ statusConfig.text }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group">
                                                        <a href="{{ path('ticket_show', {'id': ticket.id}) }}" 
                                                           class="btn btn-sm btn-outline-primary" 
                                                           title="Ver detalles">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        
                                                        {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_AUDITOR') %}
                                                            <a href="{{ path('ticket_edit', {'id': ticket.id}) }}" 
                                                               class="btn btn-sm btn-outline-secondary" 
                                                               title="Editar">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                        {% endif %}
                                                        
                                                        {% if ticket.status == 'pending' and (is_granted('ROLE_ADMIN') or is_granted('ROLE_AUDITOR')) %}
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-success" 
                                                                    title="Asignar ticket"
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#assignTicketModal"
                                                                    data-ticket-id="{{ ticket.id }}">
                                                                <i class="fas fa-user-plus"></i>
                                                            </button>
                                                        {% endif %}
                                                        
                                                        {% if ticket.status == 'in_progress' and (app.user == ticket.assignedTo or is_granted('ROLE_ADMIN') or is_granted('ROLE_AUDITOR')) %}
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-success" 
                                                                    title="Marcar como completado"
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#completeTicketModal{{ ticket.id }}">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                            
                                                            <!-- Complete Ticket Modal -->
                                                            <div class="modal fade" id="completeTicketModal{{ ticket.id }}" tabindex="-1" aria-labelledby="completeTicketModalLabel{{ ticket.id }}" aria-hidden="true">
                                                                <div class="modal-dialog">
                                                                    <div class="modal-content">
                                                                        <div class="modal-header bg-success text-white">
                                                                            <h5 class="modal-title" id="completeTicketModalLabel{{ ticket.id }}">
                                                                                <i class="fas fa-check-circle me-2"></i>Completar Ticket #{{ ticket.id }}
                                                                            </h5>
                                                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                                                        </div>
                                                                        <form method="post" action="{{ path('ticket_complete', {'id': ticket.id}) }}">
                                                                            <div class="modal-body">
                                                                                <input type="hidden" name="_token" value="{{ csrf_token('complete' ~ ticket.id) }}">
                                                                                
                                                                                <div class="mb-3">
                                                                                    <label for="notes" class="form-label">Observaciones</label>
                                                                                    <textarea class="form-control" id="notes" name="notes" rows="4" 
                                                                                              placeholder="Agregue las observaciones de la resolución del ticket" required></textarea>
                                                                                    <div class="form-text">Describa brevemente cómo se resolvió el ticket.</div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="modal-footer">
                                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                                                <button type="submit" class="btn btn-success">Confirmar completado</button>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                        
                                                        {% if is_granted('ROLE_ADMIN') %}
                                                            <form action="{{ path('ticket_delete', {'id': ticket.id}) }}" method="post" class="d-inline" onsubmit="return confirm('¿Está seguro de que desea eliminar este ticket? Esta acción no se puede deshacer.');">
                                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ ticket.id) }}">
                                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar ticket">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            {# Pagination Controls #}
                            <div class="card-footer bg-white border-top py-3">
                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                                    {# Contador de registros #}
                                    <div class="mb-2 mb-md-0">
                                        <span class="text-muted">
                                            Mostrando <strong>{{ pagination.from }} - {{ pagination.to }}</strong> de 
                                            <strong>{{ pagination.total }}</strong> registros
                                        </span>
                                    </div>
                                    
                                    {# Selector de elementos por página #}
                                    <div class="d-flex align-items-center">
                                        <span class="text-muted me-2">Mostrar:</span>
                                        <div class="btn-group me-3">
                                            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                {{ app.request.query.get('per_page', 10) }}
                                                <i class="fas fa-chevron-down ms-1"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                {% set per_page_options = [5, 10, 25, 50, 100] %}
                                                {% for option in per_page_options %}
                                                    <li>
                                                        <a class="dropdown-item d-flex justify-content-between align-items-center {{ app.request.query.get('per_page', 10) == option ? 'active' : '' }}" 
                                                           href="{{ path('ticket_index', app.request.query.all|merge({'per_page': option, 'page': 1})) }}">
                                                            {{ option }}
                                                            {% if app.request.query.get('per_page', 10) == option %}
                                                                <i class="fas fa-check ms-2"></i>
                                                            {% endif %}
                                                        </a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    {# Custom Pagination #}
                                    <div class="mt-2 mt-md-0">
                                        {% if pagination.total > 0 %}
                                            <nav aria-label="Pagination">
                                                <ul class="pagination justify-content-center">
                                                    {# Previous Page Link #}
                                                    <li class="page-item {{ pagination.current_page == 1 ? 'disabled' : '' }}">
                                                        <a class="page-link" href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({'page': pagination.current_page - 1})) }}" aria-label="Previous">
                                                            <span aria-hidden="true">&laquo;</span>
                                                        </a>
                                                    </li>
                                                    
                                                    {# Page Numbers #}
                                                    {% set startPage = max(1, pagination.current_page - 2) %}
                                                    {% set endPage = min(startPage + 4, pagination.last_page) %}
                                                    
                                                    {% if startPage > 1 %}
                                                        <li class="page-item">
                                                            <a class="page-link" href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({'page': 1})) }}">1</a>
                                                        </li>
                                                        {% if startPage > 2 %}
                                                            <li class="page-item disabled">
                                                                <span class="page-link">...</span>
                                                            </li>
                                                        {% endif %}
                                                    {% endif %}
                                                    
                                                    {% for i in startPage..endPage %}
                                                        <li class="page-item {{ pagination.current_page == i ? 'active' : '' }}">
                                                            <a class="page-link" href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({'page': i})) }}">{{ i }}</a>
                                                        </li>
                                                    {% endfor %}
                                                    
                                                    {% if endPage < pagination.last_page %}
                                                        {% if endPage < pagination.last_page - 1 %}
                                                            <li class="page-item disabled">
                                                                <span class="page-link">...</span>
                                                            </li>
                                                        {% endif %}
                                                        <li class="page-item">
                                                            <a class="page-link" href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({'page': pagination.last_page})) }}">{{ pagination.last_page }}</a>
                                                        </li>
                                                    {% endif %}
                                                    
                                                    {# Next Page Link #}
                                                    <li class="page-item {{ pagination.current_page == pagination.last_page ? 'disabled' : '' }}">
                                                        <a class="page-link" href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({'page': pagination.current_page + 1})) }}" aria-label="Next">
                                                            <span aria-hidden="true">&raquo;</span>
                                                        </a>
                                                    </li>
                                                </ul>
                                                <div class="text-center text-muted small">
                                                    Mostrando {{ pagination.from }} a {{ pagination.to }} de {{ pagination.total }} registros
                                                </div>
                                            </nav>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Assign Ticket Modal -->
    <div class="modal fade" id="assignTicketModal" tabindex="-1" aria-labelledby="assignTicketModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title d-none" id="assignTicketModalLabel">Asignar Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <form id="assignTicketForm" action="{{ path('ticket_assign') }}" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="_token" value="{{ csrf_token('assign_ticket') }}">
                        <input type="hidden" name="ticket_id" id="assign_ticket_id">
                        
                        <div class="mb-3">
                            <label for="assigned_users" class="form-label">Seleccionar usuario</label>
                            <select name="assigned_users[]" id="assigned_users" class="form-select" required>
                                <option value="">Seleccione un usuario</option>
                                {% for user in users %}
                                    <option value="{{ user.id }}">{{ user.apellido }} {{ user.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div id="userSelectionError" class="alert alert-danger d-none" role="alert">
                            Por favor seleccione un usuario válido.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Asignar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Sorting functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Handle sorting
            var sortableHeaders = document.querySelectorAll('.sortable');
            sortableHeaders.forEach(function(header) {
                header.addEventListener('click', function() {
                    var sortField = this.getAttribute('data-sort');
                    var currentUrl = new URL(window.location.href);
                    var currentSort = currentUrl.searchParams.get('sort');
                    var currentDirection = currentUrl.searchParams.get('direction');
                    
                    var newDirection = 'asc';
                    if (currentSort === sortField) {
                        newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                    }
                    
                    currentUrl.searchParams.set('sort', sortField);
                    currentUrl.searchParams.set('direction', newDirection);
                    
                    // Reset to first page when changing sort
                    currentUrl.searchParams.set('page', 1);
                    
                    window.location.href = currentUrl.toString();
                });
            });
        });

        // Assign ticket modal
        document.addEventListener('DOMContentLoaded', function() {
            var assignModal = document.getElementById('assignTicketModal');
            if (assignModal) {
                assignModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var ticketId = button.getAttribute('data-ticket-id');
                    var modalTicketId = assignModal.querySelector('#assign_ticket_id');
                    modalTicketId.value = ticketId;
                });
            }

            // Handle assign form submission
            var assignForm = document.getElementById('assignTicketForm');
            if (assignForm) {
                assignForm.addEventListener('submit', function(e) {
                    var userId = document.getElementById('user_id').value;
                    var errorDiv = document.getElementById('userSelectionError');
                    
                    if (!userId) {
                        e.preventDefault();
                        errorDiv.classList.remove('d-none');
                    } else {
                        errorDiv.classList.add('d-none');
                    }
                });
            }
        });
    </script>
{% endblock %}
