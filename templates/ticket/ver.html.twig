{% extends 'base.html.twig' %}

{% block title %}Ticket #{{ ticket.ticketId }} - {{ ticket.descripcion|u.truncate(30, '...') }}{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ path('ticket_lista') }}">Tickets</a></li>
                            <li class="breadcrumb-item active" aria-current="page">#{{ ticket.ticketId }}</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-ticket-detailed me-2"></i>Ticket #{{ ticket.ticketId }}
                    </h1>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ path('ticket_lista') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i> Volver
                    </a>
                    {% if is_granted('edit', ticket) %}
                        <a href="{{ path('ticket_editar', {'id': ticket.id}) }}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil me-1"></i> Editar
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Detalles del Ticket</h2>
                    <span class="badge bg-{{ ticket.estado == 'pendiente' ? 'warning' : (ticket.estado == 'en proceso' ? 'primary' : (ticket.estado == 'terminado' ? 'success' : 'danger')) }} text-uppercase">
                        {{ ticket.estado }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ID del Ticket:</strong> #{{ ticket.ticketId }}</p>
                            <p><strong>Área De Origen:</strong> {{ ticket.departamentoNombre }}</p>
                            <p><strong>Pedido:</strong> {{ ticket.pedido ?: 'No especificado' }}</p>
                            <p><strong>Estado:</strong> 
                                <span class="badge bg-{{ ticket.estado == 'pendiente' ? 'warning' : (ticket.estado == 'en proceso' ? 'primary' : (ticket.estado == 'terminado' ? 'success' : 'danger')) }}">
                                    {{ ticket.estado|title }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Creado por:</strong> {{ ticket.createdBy.nombre }} {{ ticket.createdBy.apellido }}</p>
                            <p><strong>Fecha de creación:</strong> {{ ticket.createdAt|date('d/m/Y H:i') }}</p>
                            {% if attribute(ticket, 'updatedAt') is defined %}
                            <p><strong>Última actualización:</strong> {{ ticket.updatedAt ? ticket.updatedAt|date('d/m/Y H:i') : 'Nunca' }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mt-4">
                        <h5 class="mb-3">Descripción</h5>
                        <div class="p-3 bg-light rounded">
                            {{ ticket.descripcion|nl2br }}
                        </div>
                    </div>

                    {% if is_granted('edit', ticket) %}
                    <div class="mt-4">
                        <h5 class="mb-3">Cambiar estado</h5>
                        <form method="post" action="{{ path('ticket_cambiar_estado', {'id': ticket.id}) }}" class="d-flex gap-2">
                            <select name="estado" class="form-select" style="max-width: 200px;">
                                <option value="pendiente" {{ ticket.estado == 'pendiente' ? 'selected' : '' }}>Pendiente</option>
                                <option value="en proceso" {{ ticket.estado == 'en proceso' ? 'selected' : '' }}>En proceso</option>
                                <option value="terminado" {{ ticket.estado == 'terminado' ? 'selected' : '' }}>Terminado</option>
                                <option value="rechazado" {{ ticket.estado == 'rechazado' ? 'selected' : '' }}>Rechazado</option>
                            </select>
                            <input type="hidden" name="_token" value="{{ csrf_token('cambiar_estado_' ~ ticket.id) }}">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i> Actualizar
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h2 class="h5 mb-0">
                                <i class="bi bi-people me-2"></i> Colaboradores
                                <span class="badge bg-secondary">{{ ticket.collaborators|length }}</span>
                            </h2>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0 me-2">
                                                <div class="avatar-sm rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <span class="text-primary fw-medium">
                                                        {{ ticket.createdBy.nombre|first|upper }}{{ ticket.createdBy.apellido|first|upper }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="fw-medium">{{ ticket.createdBy.nombre }} {{ ticket.createdBy.apellido }}</div>
                                                <small class="text-muted">{{ ticket.createdBy.email }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="badge bg-primary">Creador</span>
                                </li>
                                {% for collaborator in ticket.collaborators %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0 me-2">
                                            <div class="avatar-sm rounded-circle bg-secondary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <span class="text-secondary fw-medium">
                                                    {{ collaborator.nombre|first|upper }}{{ collaborator.apellido|first|upper }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-medium">{{ collaborator.nombre }} {{ collaborator.apellido }}</div>
                                            <small class="text-muted">{{ collaborator.email }}</small>
                                        </div>
                                    </div>
                                    <span class="badge bg-secondary">Colaborador</span>
                                </li>
                                {% endfor %}
                                {% if is_granted('edit', ticket) %}
                                <li class="list-group-item">
                                    <form action="{{ path('ticket_agregar_colaborador', {'id': ticket.id}) }}" method="POST" class="d-flex gap-2">
                                        <select name="usuario" class="form-select form-select-sm" required>
                                            <option value="">Seleccionar colaborador...</option>
                                            {% for user in users %}
                                                {% if user.id != ticket.createdBy.id and not ticket.collaborators.contains(user) %}
                                                    <option value="{{ user.id }}">{{ user.nombre }} {{ user.apellido }} ({{ user.email }})</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </form>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <!-- Tareas -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h2 class="h5 mb-0">
                                <i class="bi bi-list-check me-2"></i> Tareas
                                <span class="badge bg-{{ ticket.tasks|filter(t => not t.completed)|length > 0 ? 'warning' : 'success' }}" id="pending-tasks-count">
                                    {{ ticket.tasks|filter(t => not t.completed)|length }} pendiente(s)
                                </span>
                            </h2>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                                <i class="bi bi-plus-lg"></i> Agregar
                            </button>
                        </div>
                        <div class="card-body">
                            {% if ticket.tasks|length > 0 %}
                                <div class="list-group list-group-flush" id="tasks-list">
                                    {% for task in ticket.tasks %}
                                        <div class="list-group-item d-flex align-items-center">
                                            <div class="form-check me-2">
                                                <input class="form-check-input task-checkbox" 
                                                       type="checkbox" 
                                                       data-task-id="{{ task.id }}"
                                                       {% if task.completed %}checked{% endif %}>
                                            </div>
                                            <div class="flex-grow-1 {% if task.completed %}text-muted text-decoration-line-through{% endif %}">
                                                {{ task.description }}
                                                <div class="text-muted small">
                                                    Creada el {{ task.createdAt|date('d/m/Y H:i') }}
                                                    {% if task.completed and task.completedAt %}
                                                        • Completada el {{ task.completedAt|date('d/m/Y H:i') }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger delete-task" data-task-id="{{ task.id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-3 text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    No hay tareas pendientes
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Historial de Actividades -->
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h2 class="h5 mb-0">
                                <i class="bi bi-clock-history me-2"></i> Historial de Actividades
                            </h2>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-badge bg-primary">
                                        <i class="bi bi-plus-lg"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Ticket creado</h6>
                                        <p class="mb-0 text-muted small">
                                            Por {{ ticket.createdBy.nombre }} {{ ticket.createdBy.apellido }} el {{ ticket.createdAt|date('d/m/Y H:i') }}
                                        </p>
                                    </div>
                                </div>
                                {% if ticket.updatedAt is defined and ticket.updatedAt is not null %}
                                <div class="timeline-item">
                                    <div class="timeline-badge bg-info">
                                        <i class="bi bi-pencil"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Ticket actualizado</h6>
                                        <p class="mb-0 text-muted small">
                                            Última actualización el {{ ticket.updatedAt|date('d/m/Y H:i') }}
                                        </p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {{ form_start(task_form, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate'}}) }}
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Tarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {{ form_widget(task_form) }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            {{ form_end(task_form) }}
        </div>
    </div>
</div>

<!-- Delete Task Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar Tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar esta tarea? Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTask">Eliminar</button>
            </div>
        </div>
    </div>
</div>

{% block javascripts %}
{{ parent() }}
<script src="{{ asset('assets/js/task-manager.js') }}"></script>
{% endblock %}

</div>

{% endblock %}
