{% extends 'base.html.twig' %}

{% block title %}Ticket #{{ ticket.id }} - {{ ticket.descripcion|u.truncate(30, '...') }}{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <a href="{{ path('ticket_lista') }}" class="text-decoration-none text-dark">
                <i class="bi bi-arrow-left"></i>
            </a>
            Ticket #{{ ticket.ticketId }}
        </h1>
        <div class="d-flex gap-2">
            <a href="{{ path('ticket_editar', {'id': ticket.id}) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Editar
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Detalles del Ticket</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-1">Descripción</h6>
                        <p class="mb-0">{{ ticket.descripcion }}</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">Estado</h6>
                            <span class="badge bg-{{ ticket.estado == 'completado' ? 'success' : (ticket.estado == 'en_progreso' ? 'primary' : 'warning') }}">
                                {{ ticket.estado|replace({'_': ' '})|title }}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">Departamento</h6>
                            <p class="mb-0">{{ ticket.departamentoNombre }}</p>
                        </div>
                    </div>
                    
                    {% if ticket.pedido %}
                    <div class="mt-3">
                        <h6 class="text-muted mb-1">Pedido</h6>
                        <p class="mb-0">{{ ticket.pedido }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tareas Pendientes -->
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Tareas Pendientes</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for task in ticket.tasks %}
                            <div class="list-group-item">
                                <div class="form-check d-flex align-items-center">
                                    <input class="form-check-input me-3 task-checkbox" 
                                           type="checkbox" 
                                           data-task-id="{{ task.id }}"
                                           {{ task.completed ? 'checked' : '' }}
                                           style="width: 1.2rem; height: 1.2rem;">
                                    <label class="form-check-label flex-grow-1 {{ task.completed ? 'text-muted text-decoration-line-through' : '' }}">
                                        {{ task.description }}
                                        <small class="d-block text-muted">
                                            Creado el {{ task.createdAt|date('d/m/Y H:i') }}
                                            {% if task.completedAt %}
                                                • Completado el {{ task.completedAt|date('d/m/Y H:i') }}
                                            {% endif %}
                                        </small>
                                    </label>
                                    <button class="btn btn-sm btn-outline-danger delete-task" data-task-id="{{ task.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center p-4 text-muted">
                                No hay tareas pendientes. ¡Agrega una nueva tarea!
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="p-3 border-top">
                        {{ form_start(task_form, {'attr': {'class': 'd-flex gap-2'}}) }}
                            <div class="flex-grow-1">
                                {{ form_widget(task_form.description, {'attr': {
                                    'class': 'form-control',
                                    'placeholder': 'Añadir una nueva tarea...'
                                }}) }}
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-lg"></i> Agregar
                            </button>
                        {{ form_end(task_form) }}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Información del Ticket</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-1">Creado por</h6>
                        <p class="mb-0">
                            {{ ticket.createdBy.nombre }} {{ ticket.createdBy.apellido }}
                        </p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-1">Fecha de creación</h6>
                        <p class="mb-0">{{ ticket.createdAt|date('d/m/Y H:i') }}</p>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">ID del ticket</h6>
                        <p class="mb-0">{{ ticket.ticketId }}</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Colaboradores</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-person-fill me-2"></i>
                            {{ ticket.createdBy.nombre }} {{ ticket.createdBy.apellido }} (Creador)
                        </li>
                        {% for collaborator in ticket.collaborators %}
                            <li class="mb-2">
                                <i class="bi bi-person me-2"></i>
                                {{ collaborator.user.nombre }} {{ collaborator.user.apellido }}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Task Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar esta tarea? Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTask">Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle task completion
    document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const taskId = this.dataset.taskId;
            const isCompleted = this.checked;
            
            fetch(`/ticket/task/${taskId}/toggle`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ completed: isCompleted })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const label = this.closest('.form-check').querySelector('.form-check-label');
                    if (isCompleted) {
                        label.classList.add('text-muted', 'text-decoration-line-through');
                    } else {
                        label.classList.remove('text-muted', 'text-decoration-line-through');
                    }
                    
                    // Optional: Show a success message
                    const toast = new bootstrap.Toast(document.getElementById('toast'));
                    const toastBody = document.querySelector('.toast-body');
                    toastBody.textContent = isCompleted ? 'Tarea marcada como completada' : 'Tarea marcada como pendiente';
                    toast.show();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.checked = !isCompleted; // Revert checkbox state on error
            });
        });
    });
    
    // Delete task
    let taskToDelete = null;
    const deleteButtons = document.querySelectorAll('.delete-task');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            taskToDelete = this.dataset.taskId;
            deleteModal.show();
        });
    });
    
    document.getElementById('confirmDeleteTask').addEventListener('click', function() {
        if (!taskToDelete) return;
        
        fetch(`/ticket/task/${taskToDelete}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the task from the UI
                document.querySelector(`.delete-task[data-task-id="${taskToDelete}"]`).closest('.list-group-item').remove();
                
                // Show success message
                const toast = new bootstrap.Toast(document.getElementById('toast'));
                const toastBody = document.querySelector('.toast-body');
                toastBody.textContent = 'Tarea eliminada correctamente';
                toast.show();
                
                // If no tasks left, show the empty state
                const taskList = document.querySelector('.list-group');
                if (taskList.children.length === 1) { // Only the empty state message remains
                    taskList.innerHTML = `
                        <div class="text-center p-4 text-muted">
                            No hay tareas pendientes. ¡Agrega una nueva tarea!
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
        })
        .finally(() => {
            deleteModal.hide();
            taskToDelete = null;
        });
    });
    
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
