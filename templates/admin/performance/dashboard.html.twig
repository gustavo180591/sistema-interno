{% extends 'maintenance/base.html.twig' %}

{% block title %}Dashboard de Rendimiento{% endblock %}

{% block page_title %}
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" href="#personal" data-bs-toggle="tab">Rendimiento del Personal</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#equipo" data-bs-toggle="tab">Rendimiento del Equipo</a>
        </li>
    </ul>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .kpi-card { border-left: 4px solid; }
        .kpi-card .card-title { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .kpi-card .display-6 { font-weight: 600; }
        .progress { height: 6px; }
        .progress-sm { height: 4px; }
        .table th { font-weight: 600; white-space: nowrap; }
        .score-badge { min-width: 60px; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-end mb-3">
        <form method="get" class="row g-2">
            <div class="col-auto">
                <input type="date" name="from" value="{{ from|date('Y-m-d') }}" class="form-control form-control-sm">
            </div>
            <div class="col-auto">
                <input type="date" name="to" value="{{ to|date('Y-m-d') }}" class="form-control form-control-sm">
            </div>
            <div class="col-auto">
                <button class="btn btn-sm btn-primary">
                    <i class="fas fa-filter me-1"></i>Filtrar
                </button>
            </div>
        </form>
    </div>

    <div class="tab-content">
        <!-- Pestaña de Rendimiento del Personal -->
        <div class="tab-pane fade show active" id="personal">

    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="card kpi-card border-left-primary">
                <div class="card-body">
                    <div class="text-muted small">Tickets cerrados</div>
                    <div class="display-6">{{ summary.totalCerrados|default(0) }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card border-left-info">
                <div class="card-body">
                    <div class="text-muted small">TMR (horas)</div>
                    <div class="display-6">{{ summary.tmrHoras|default(0)|number_format(1, '.', ',') }}</div>
                </div>
            </div>
        </div>
    </div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table align-middle table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Usuario</th>
                        <th class="text-center">Cerrados</th>
                        <th class="text-center">TMR</th>
                        <th class="text-center">Reab.</th>
                        <th>Score</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for r in ranking %}
                    {% set s = r.score %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>
                            <div class="fw-semibold">{{ r.nombre }} {{ r.apellido }}</div>
                            <div class="text-muted small">{{ r.username }}</div>
                        </td>
                        <td class="text-center">{{ s.raw.cerr }}</td>
                        <td class="text-center">{{ s.raw.tmr|number_format(1) }} h</td>
                        <td class="text-center">{{ s.raw.reab|number_format(1) }}%</td>
                        <td style="min-width:160px;">
                            <div class="d-flex align-items-center gap-2">
                                <div class="progress flex-grow-1" style="height:10px;">
                                    <div class="progress-bar bg-{{ s.final > 80 ? 'success' : (s.final > 60 ? 'warning' : 'danger') }}" 
                                         style="width: {{ s.final }}%">
                                    </div>
                                </div>
                                <span class="badge bg-{{ s.final > 80 ? 'success' : (s.final > 60 ? 'warning' : 'danger') }} score-badge">
                                    {{ s.final|number_format(1) }}
                                </span>
                            </div>
                            <div class="text-muted small">
                                Prod {{ s.prod }} · Cal {{ s.calidad }} · Col {{ s.colaboracion }}
                            </div>
                        </td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-secondary"
                               href="{{ path('admin_admin_performance_performance_user', { id: r.userId, from: from|date('Y-m-d'), to: to|date('Y-m-d') }) }}">
                                <i class="fas fa-user me-1"></i>Ver
                            </a>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2 d-block text-muted"></i>
                            No hay datos para mostrar
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
        </table>
    </div>
</div>

<div class="row g-3 mb-3 d-none">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white">Tareas completadas por usuario</div>
            <div class="card-body">
                <canvas id="barChart" height="180"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white">Tiempo promedio (líneas)</div>
            <div class="card-body">
                <canvas id="lineChart" height="180"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-white">Detalle por usuario</div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="performanceTable">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th class="text-center">Tareas</th>
                    <th class="text-center">Tickets</th>
                    <th class="text-center">Rendimiento</th>
                    <th class="text-center">Detalle</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
            </div>
        </div>

        <!-- Pestaña de Rendimiento del Equipo -->
        <div class="tab-pane fade" id="equipo">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">Métricas del Equipo</h5>
                    <div class="row g-4">
                        <div class="col-md-6 col-lg-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 fw-bold text-primary">{{ summary.totalCerrados|default(0) }}</div>
                                    <div class="text-muted">Tickets Cerrados</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 fw-bold text-info">{{ summary.tmrHoras|default(0)|number_format(1) }}</div>
                                    <div class="text-muted">TMR Promedio (horas)</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 fw-bold text-success">
                                        {% if ranking|length > 0 %}
                                            {{ (ranking|reduce((sum, r) => sum + r.score.raw.cerr, 0) / ranking|length)|number_format(1) }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </div>
                                    <div class="text-muted">Tickets/Prom. por Usuario</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 fw-bold text-warning">
                                        {{ summary.reabiertos|default(0) }}
                                    </div>
                                    <div class="text-muted">Tickets Reabiertos</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">Distribución de Tickets</h5>
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="teamPerformanceChart" height="250"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div class="mt-3">
                                <h6 class="mb-3">Estadísticas Adicionales</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Usuarios Activos</span>
                                    <strong>{{ ranking|length }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Período</span>
                                    <strong>{{ from|date('d/m/Y') }} - {{ to|date('d/m/Y') }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Días del Período</span>
                                    <strong>{{ (to.diff(from).days + 1) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Tickets/Día</span>
                                    <strong>
                                        {% set days = (to.diff(from).days + 1) %}
                                        {% if days > 0 %}
                                            {{ (summary.totalCerrados / days)|number_format(1) }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Initialize date range picker if available
            if (typeof $.fn.daterangepicker !== 'undefined' && $('input[name="date_range"]').length) {
                $('input[name="date_range"]').daterangepicker({
                    locale: {
                        format: 'DD/MM/YYYY',
                        applyLabel: 'Aplicar',
                        cancelLabel: 'Cancelar',
                        fromLabel: 'Desde',
                        toLabel: 'Hasta',
                        customRangeLabel: 'Personalizado',
                        daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                        monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                        firstDay: 1
                    },
                    startDate: '{{ from|date('d/m/Y') }}',
                    endDate: '{{ to|date('Y-m-d') }}',
                    ranges: {
                       'Hoy': [moment(), moment()],
                       'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                       'Últimos 7 Días': [moment().subtract(6, 'days'), moment()],
                       'Últimos 30 Días': [moment().subtract(29, 'days'), moment()],
                       'Este Mes': [moment().startOf('month'), moment().endOf('month')],
                       'Mes Anterior': [
                           moment().subtract(1, 'month').startOf('month'), 
                           moment().subtract(1, 'month').endOf('month')
                       ]
                    }
                }, function(start, end) {
                    const from = start.format('YYYY-MM-DD');
                    const to = end.format('YYYY-MM-DD');
                    window.location.href = `?from=${from}&to=${to}`;
                });
            }
            
            // Initialize progress bars
            document.querySelectorAll('.progress-bar').forEach(bar => {
                const width = bar.getAttribute('aria-valuenow') || 0;
                bar.style.width = `${width}%`;
            });
            
            // Handle user details click
            document.querySelectorAll('.btn-view-user').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const userId = this.getAttribute('data-user-id');
                    if (userId) {
                        window.location.href = this.getAttribute('href');
                    }
                });
            });
        });
        
        // Initialize team performance chart when tab is shown
        document.getElementById('equipo-tab').addEventListener('shown.bs.tab', function () {
            const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: {{ ranking|map(r => r.nombre ~ ' ' ~ r.apellido)|json_encode|raw }},
                    datasets: [{
                        label: 'Tickets Cerrados',
                        data: {{ ranking|map(r => r.score.raw.cerr)|json_encode|raw }},
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Tickets Cerrados por Usuario'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}

{% block styles %}
{{ parent() }}
<style>
.avatar-sm {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
}
.progress {
    background-color: #e9ecef;
    border-radius: 2px;
}
.progress-bar {
    transition: width 0.6s ease;
}
.table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}
</style>
{% endblock %}
