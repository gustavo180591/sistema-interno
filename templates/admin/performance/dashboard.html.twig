{% extends 'base.html.twig' %}

{% block title %}Rendimiento de Personal{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .kpi-card .display-6 { font-weight: 600; }
        .avatar-sm { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            background: #e9ecef; 
        }
        .progress { height: 0.5rem; }
        .table th { font-weight: 600; }
    </style>
{% endblock %}

{% block body %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 mb-0"><i class="fas fa-chart-line me-2 text-warning"></i>Rendimiento de Personal</h1>
    <a href="{{ path('admin_dashboard') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Volver al Inicio
    </a>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">Desde</label>
                <input type="date" class="form-control" name="from" value="{{ from|date('Y-m-d') }}" required>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Hasta</label>
                <input type="date" class="form-control" name="to" value="{{ to|date('Y-m-d') }}" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-1"></i>Filtrar
                </button>
            </div>
            <div class="col-md-2">
                <a href="{{ path('admin_dashboard') }}" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-sync-alt me-1"></i>Restablecer
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-white">
        <h5 class="mb-0">Resumen de Rendimiento</h5>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Usuario</th>
                    <th class="text-center">Asignadas</th>
                    <th class="text-center">Completadas</th>
                    <th class="text-center">En Progreso</th>
                    <th class="text-center">Promedio (min)</th>
                    <th class="text-center">Efectividad</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% if summary|length > 0 %}
                    {% set totalAssigned = 0 %}
                    {% set totalCompleted = 0 %}
                    {% set totalInProgress = 0 %}
                    
                    {% for user in summary %}
                        {% set totalAssigned = totalAssigned + user.assignedCount %}
                        {% set totalCompleted = totalCompleted + user.completedCount %}
                        {% set totalInProgress = totalInProgress + user.inProgressCount %}
                        
                        <tr>
                            <td class="fw-medium">
                                <i class="fas fa-user-circle me-2 text-primary"></i>
                                {{ user.apellido }}, {{ user.nombre }}
                            </td>
                            <td class="text-center">{{ user.assignedCount }}</td>
                            <td class="text-center">
                                <span class="badge bg-success bg-opacity-10 text-success">
                                    {{ user.completedCount }}
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-primary bg-opacity-10 text-primary">
                                    {{ user.inProgressCount }}
                                </span>
                            </td>
                            <td class="text-center fw-medium">
                                {{ user.avgMinutes ? user.avgMinutes|number_format(1, ',', '.') : '-' }}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                        {% set effectiveness = (user.completedCount / (user.assignedCount ?: 1)) * 100 %}
                                        <div class="progress-bar bg-{{ effectiveness > 80 ? 'success' : (effectiveness > 50 ? 'warning' : 'danger') }}" 
                                             role="progressbar" 
                                             style="width: {{ effectiveness|min(100) }}%" 
                                             aria-valuenow="{{ effectiveness }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    <span class="small fw-medium">{{ effectiveness|number_format(1) }}%</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <a href="{{ path('admin_performance_user', {'id': user.userId, 'from': from|date('Y-m-d'), 'to': to|date('Y-m-d')}) }}" 
                                   class="btn btn-sm btn-outline-primary"
                                   title="Ver detalles del usuario">
                                    <i class="fas fa-eye"></i> Detalles
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    
                    <!-- Total row -->
                    <tr class="table-light fw-bold">
                        <td>Total</td>
                        <td class="text-center">{{ totalAssigned }}</td>
                        <td class="text-center">{{ totalCompleted }}</td>
                        <td class="text-center">{{ totalInProgress }}</td>
                        <td class="text-center">-</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                    {% set totalEffectiveness = totalAssigned > 0 ? (totalCompleted / totalAssigned) * 100 : 0 %}
                                    <div class="progress-bar bg-{{ totalEffectiveness > 80 ? 'success' : (totalEffectiveness > 50 ? 'warning' : 'danger') }}" 
                                         role="progressbar" 
                                         style="width: {{ totalEffectiveness|min(100) }}%" 
                                         aria-valuenow="{{ totalEffectiveness }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <span class="small fw-bold">{{ totalEffectiveness|number_format(1) }}%</span>
                            </div>
                        </td>
                        <td></td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <div class="mb-2">
                                <i class="fas fa-inbox fa-3x opacity-25 mb-3"></i>
                            </div>
                            <h6 class="mb-1">No hay datos disponibles</h6>
                            <p class="small mb-0">No se encontraron registros para el rango de fechas seleccionado.</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div class="row g-3 mb-3 d-none">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white">Tareas completadas por usuario</div>
            <div class="card-body">
                <canvas id="barChart" height="180"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white">Tiempo promedio (l√≠neas)</div>
            <div class="card-body">
                <canvas id="lineChart" height="180"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-white">Detalle por usuario</div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="performanceTable">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th class="text-center">Tareas</th>
                    <th class="text-center">Tickets</th>
                    <th class="text-center">Rendimiento</th>
                    <th class="text-center">Detalle</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
    const form = document.getElementById('filtersForm');
    const resetBtn = document.getElementById('resetBtn');

    const kpiCompleted = document.getElementById('kpiCompleted');
    const kpiAvg = document.getElementById('kpiAvg');
    const kpiEffectiveness = document.getElementById('kpiEffectiveness');
    const kpiInProgress = document.getElementById('kpiInProgress');
    const kpiPending = document.getElementById('kpiPending');
    const employeeOfMonth = document.getElementById('employeeOfMonth');

    let barChart, lineChart;

    async function fetchData(params) {
        const qs = new URLSearchParams(params).toString();
        const res = await fetch('{{ path('admin_performance_data') }}?' + qs);
        if (!res.ok) throw new Error('Error al cargar datos');
        return res.json();
    }

    function renderKPIs(kpis) {
        kpiCompleted.textContent = kpis.totalCompleted;
        kpiAvg.textContent = (kpis.avgDurationMin || 0) + ' min';
        kpiEffectiveness.textContent = (kpis.effectiveness || 0) + '%';
        kpiInProgress.textContent = kpis.inProgress || 0;
        kpiPending.textContent = kpis.pending || 0;
        employeeOfMonth.textContent = kpis.employeeOfMonth || '-';
    }

    function ensureCharts() {
        const barCtx = document.getElementById('barChart');
        const lineCtx = document.getElementById('lineChart');
        if (barChart) barChart.destroy();
        if (lineChart) lineChart.destroy();
        barChart = new Chart(barCtx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Completadas', data: [], backgroundColor: '#0d6efd' }] },
            options: { responsive: true, plugins: { legend: { display: false }}}
        });
        lineChart = new Chart(lineCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Promedio (min)', data: [], borderColor: '#20c997' }] },
            options: { responsive: true }
        });
    }

    function renderCharts(payload) {
        barChart.data.labels = payload.bar.labels;
        barChart.data.datasets[0].data = payload.bar.data;
        barChart.update();
        lineChart.data.labels = payload.bar.labels;
        lineChart.data.datasets[0].data = payload.table.map(r => r.avgDurationMin);
        lineChart.update();
    }

    function renderTable(rows) {
        const tbody = document.querySelector('#performanceTable tbody');
        tbody.innerHTML = '';
        tbody.innerHTML = '';
        if (!rows.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" class="text-center text-muted py-4">Sin datos para el rango seleccionado</td>';
            tbody.appendChild(tr);
            return;
        }
        rows.forEach(row => {
            const tr = document.createElement('tr');
            const progress = Math.min(100, Math.max(0, row.effectiveness || 0));
            const progressClass = progress > 80 ? 'bg-success' : progress > 50 ? 'bg-warning' : 'bg-danger';
            
            tr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar-sm me-2">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div class="fw-medium">${row.userName}</div>
                            <small class="text-muted">${row.userEmail || ''}</small>
                        </div>
                    </div>
                </td>
                <td class="text-center">
                    <div class="d-flex flex-column">
                        <span class="fw-medium">${row.assigned || 0} <small>asignadas</small></span>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar ${progressClass}" style="width: ${progress}%" role="progressbar"></div>
                        </div>
                        <small class="text-muted">${row.completed || 0} completadas (${row.effectiveness || 0}%)</small>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary rounded-pill">${row.ticketsCompleted || 0} cerrados</span>
                    ${row.lastTicketDate ? `<div class="small text-muted mt-1">√öltimo: ${row.lastTicketDate}</div>` : ''}
                </td>
                <td class="text-center">
                    <div class="d-flex flex-column">
                        <span class="small">‚è±Ô∏è ${row.avgDurationMin || 0} min/promedio</span>
                        <span class="small">üèÜ ${row.completedThisMonth || 0} este mes</span>
                    </div>
                </td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewUserDetails(${row.userId || 0})">
                        <i class="fas fa-chart-line me-1"></i>Ver detalles
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function load() {
        const formData = new FormData(form);
        const params = {};
        for (const [k, v] of formData.entries()) {
            if (params[k]) {
                if (!Array.isArray(params[k])) params[k] = [params[k]];
                params[k].push(v);
            } else {
                params[k] = v;
            }
        }
        try {
            ensureCharts();
            const data = await fetchData(params);
            renderKPIs(data.kpis);
            renderCharts(data);
            renderTable(data.table);
        } catch (e) {
            showNotification('Error', e.message, 'danger');
        }
    }

    form.addEventListener('submit', function(ev) {
        ev.preventDefault();
        load();
    });

    resetBtn.addEventListener('click', function() {
        form.reset();
        load();
    });

    load();
})();
</script>
<script>
function viewUserDetails(userId) {
    // Implementar vista detallada del usuario
    alert('Vista detallada del usuario ' + userId + ' se abrir√° aqu√≠');
    // Aqu√≠ podr√≠as abrir un modal o redirigir a una vista detallada
}
</script>
<style>
.avatar-sm {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
}
.progress {
    background-color: #e9ecef;
    border-radius: 2px;
}
.progress-bar {
    transition: width 0.6s ease;
}
.table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}
</style>
{% endblock %}
